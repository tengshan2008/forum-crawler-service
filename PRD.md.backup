# 论坛小说与图片爬取服务 - 产品需求文档 (PRD)

## 📊 项目概述与实现状态

本项目是一个**完整的生产级论坛爬虫服务**，采用微服务架构，包含Node.js后端、Python爬虫、React前端。当前已实现核心功能并支持Docker容器化部署。

### 功能实现总览

| 功能模块 | 实现状态 | 完成度 | 优先级 |
|---------|--------|--------|--------|
| **任务管理** | ✅ 完全实现 | 100% | P0 |
| **爬虫核心** | ✅ 完全实现 | 100% | P0 |
| **多分页聚合** | ✅ 完全实现 | 100% | P0 |
| **Web UI** | ✅ 完全实现 | 100% | P0 |
| **内容预览** | ✅ 完全实现 | 100% | P0 |
| **用户认证系统** | ❌ 规划中 | 0% | P1 |
| **权限管理** | ❌ 规划中 | 0% | P1 |
| **高级搜索** | ⚠️ 基础实现 | 40% | P2 |
| **内容导出** | ❌ 规划中 | 0% | P2 |
| **系统管理** | ❌ 规划中 | 0% | P3 |
| **推荐系统** | ❌ 规划中 | 0% | P3 |
| **多论坛支持** | ⚠️ 仅支持t66y | 20% | P2 |

---

## 1. ✅ 已完全实现的功能

### 1.1 爬取任务管理系统
### 1.1 爬取任务管理系统

#### 任务CRUD操作（✅ 完全实现）
- **创建任务**
  - 任务名称和描述输入
  - 目标论坛URL输入
  - 任务类型选择：`novel`（小说/文本）、`image`（图片）、`mixed`（混合）
  - 高级参数配置：最大深度（maxDepth）、请求延迟（delay）、超时时间（timeout）
  - 表单验证和错误提示
  
- **查看任务**
  - 任务列表页面，表格视图展示所有任务
  - 显示字段：任务名称、类型、状态、进度、创建时间、最后更新时间
  - 任务详情页面，包含完整配置和执行统计
  - 支持按状态快速筛选（pending/running/completed/failed/paused）
  - 支持按创建时间排序
  
- **编辑任务**
  - 修改任务基本信息（名称、描述）
  - 修改爬取参数（仅在pending状态允许）
  - 更新高级配置
  
- **删除任务**
  - 删除任务记录
  - 级联删除相关爬取的内容
  - 删除任务下载的图片文件

#### 任务执行控制（✅ 完全实现）
- **任务状态管理**
  - 状态流转：pending → running → completed/failed 或 running → paused → running/cancelled
  - 启动任务：从pending转入running状态，触发爬虫执行
  - 暂停任务：将running的任务暂停，保留进度
  - 恢复任务：从paused状态恢复执行
  - 取消任务：停止任务执行，标记为cancelled
  
- **进度追踪**
  - 实时进度条显示（0-100%）
  - 爬取项数统计：totalItems（总项数）、crawledItems（已爬项数）、failedItems（失败项数）
  - 执行时间记录：startTime、endTime、耗时时长
  - 错误日志累积和显示

#### 任务配置参数（✅ 完全实现）
```javascript
{
  name: String,              // 任务名称
  description: String,       // 任务描述
  forumUrl: String,          // 论坛URL
  taskType: String,          // 任务类型: novel|image|mixed
  status: String,            // 状态: pending|running|completed|failed|paused
  progress: Number,          // 进度: 0-100
  totalItems: Number,        // 总项数
  crawledItems: Number,      // 已爬项数
  failedItems: Number,       // 失败项数
  config: {
    maxDepth: Number,        // 最大深度 (默认3)
    delay: Number,           // 请求延迟ms (默认1000)
    timeout: Number          // 超时时间ms (默认600000)
  },
  errorLog: Array,           // 错误日志
  createdAt: Date,
  updatedAt: Date,
  startTime: Date,
  endTime: Date
}
```

---

### 1.2 爬虫核心功能系统
- **网站特征识别**
  - 自动识别页面为t66y格式
  - 支持多种URL格式（htm_data路径、read.php查询参数）
  
- **内容结构解析**
  - 自动提取帖子标题
  - 识别多个楼层（每个楼层为一个`div.tpc_content`）
  - 自动提取楼主信息

### 2.2 多楼层内容提取

- **楼层识别机制**
  - 通过CSS选择器`div.tpc_content`识别楼层
  - 支持任意数量的楼层
  - 无需依赖"楼主"文本标记
  
- **内容聚合**
  - 按顺序提取所有楼层文本
  - 楼层间用`\n\n`（双换行）分隔
  - 支持同一楼层内的多个内容块

### 2.3 多分页内容聚合 ⭐ (NEW)

这是最近的重大功能升级，解决了原有的**多页内容缺失问题**。

#### 工作原理
```
首页HTML
    ↓
检测分页数（extract_page_numbers）
    ↓
循环遍历所有页面（2-N页）
    ├─ 构建分页URL（build_pagination_url）
    ├─ 获取页面HTML（fetch_page）
    ├─ 提取页面楼层（_extract_page_content）
    └─ 聚合内容
    ↓
合并所有页面的楼层（'\n\n'分隔）
    ↓
保存完整内容到MongoDB
```

#### 核心实现
- **分页检测**（`extract_page_numbers`）
  - 从首页HTML解析所有`<a>`标签
  - 提取所有`page=N`参数值
  - 返回最大页码作为总分页数
  
- **URL构建**（`build_pagination_url`）
  - 从原始URL提取thread ID（tid）
  - 支持两种URL格式自动识别：
    - 直接分页：`read.php?tid=XXX&page=1`
    - HTML数据：`htm_data/XXX/YY/ZZZZZZZZ.html`
  - 为每页生成标准访问URL
  
- **多页遍历**（`parse_t66y_post`）
  - 第1步：提取首页内容
  - 第2步：检测总分页数
  - 第3步：如果多页，循环获取第2-N页
  - 第4步：用`\n\n`合并所有页面的楼层
  
- **单页提取**（`_extract_page_content`）
  - 从该页HTML提取所有`tpc_content` div
  - 逐楼层提取文本内容
  - 同时提取楼层内的所有图片
  - 新增参数标记当前页码和楼层编号

#### 性能与容错
- **请求超时**：每页HTTP请求10秒超时
- **容错机制**：单页失败自动跳过，继续下一页
- **去重保护**：自动过滤重复图片URL
- **向后兼容**：单页帖子继续正常工作

#### 测试验证
实测6页帖子（6楼层分布）：
- 总内容：49,995字符
- 处理时间：~3秒
- 楼层检测：100%准确
- 内容完整性：100%

### 2.4 内容类型处理

#### 小说/文本模式（novel）
- 提取纯文本内容，不下载图片
- 保存完整的多楼层文本
- 适用于小说、教程、讨论帖

#### 图片模式（image）
- 自动识别和下载所有图片
- 智能过滤小图标和表情
- 按任务ID组织本地存储
- 返回本地访问路径

#### 混合模式（mixed）
- 同时提取文本和图片
- 既保存内容，也保存媒体
- 适用于综合贴子

### 2.5 图片处理

#### 图片识别
- 支持多种HTML属性识别图片：
  - `ess-data`：t66y论坛的实际图片URL属性
  - `src`：标准HTML img标签
  - `data-src`：懒加载图片
  
#### 智能过滤
自动过滤非内容图片：
  - emotion：表情符号
  - icon：网站图标
  - avatar：用户头像
  - face：脸部识别类图片

#### 本地存储
- 按任务ID创建图片目录
- 生成本地访问路径：`/public/images/uploads/{taskId}/{filename}`
- 避免重复下载（URL去重）

---

## 3. ✅ Web用户界面（已完全实现）

### 3.1 任务管理界面

## 3. 内容管理界面
### 小说内容管理
- **小说列表展示**
  - 表格/卡片视图切换
  - 按论坛、更新时间、热度排序
  - 标签分类系统
- **阅读器功能**
  - 章节目录导航
  - 阅读进度保存
  - 字体/主题自定义
  - 夜间模式
- **批量操作**
  - 批量导出（TXT、EPUB、PDF）
  - 批量删除
  - 批量添加标签

### 图片内容管理
- **图库浏览**
  - 瀑布流展示
  - 幻灯片模式
  - 缩略图/原图切换
- **图片处理**
  - 在线预览大图
  - 基础图片编辑（裁剪、旋转）
  - 图片信息查看（EXIF数据）
- **批量下载**
  - 按专辑打包下载
  - 选择性下载原图/压缩图
  - 生成下载链接

## 4. 智能处理功能
### 内容智能识别
- **小说识别**
  - 自动识别连载小说
  - 章节自动合并
  - 作者信息提取
  - 去重检测
- **图片智能分类**
  - 基于AI的图像分类（风景、人物、动漫等）
  - 相似图片检测
  - NSFW内容过滤

### 内容增强
- **小说格式化**
  - 自动校正错别字
  - 段落优化
  - 移除广告内容
- **图片优化**
  - 自动去除水印（可选）
  - 批量压缩
  - 格式转换

## 5. 搜索与发现
- **高级搜索系统**
  - 全文检索（标题、内容）
  - 多条件筛选（论坛、时间、类型）
  - 保存搜索条件
- **推荐系统**
  - 基于用户行为的推荐
  - 热门内容榜单
  - 相似内容推荐

## 6. 导出与分享
- **导出选项**
  - 小说导出：TXT、EPUB、MOBI、PDF
  - 图片导出：ZIP包、云相册链接
  - 元数据导出（JSON/CSV）
- **分享功能**
  - 生成分享链接
  - 嵌入代码生成
  - 社交媒体分享

## 7. 系统管理
### 配置管理
- **爬虫设置**
  - 请求间隔控制（防封禁）
  - 代理服务器配置
  - User-Agent轮换
  - Cookies管理
- **存储设置**
  - 本地/云存储选择（S3、OSS等）
  - 存储配额管理
  - 自动清理规则

### 数据统计与分析
- **系统仪表板**
  - 总数据量统计
  - 用户活跃度分析
  - 存储使用情况
- **爬取效果分析**
  - 各论坛爬取成功率
  - 热门内容趋势
  - 异常检测报告

## 8. API与扩展
- **RESTful API**
  - 任务管理API
  - 内容查询API
  - 数据导出API
- **插件系统**
  - 自定义爬虫插件
  - 导出格式插件
  - 内容处理插件

## 9. 安全与合规
- **访问控制**
  - IP限制访问
  - API密钥管理
  - 操作日志审计
- **合规功能**
  - Robots.txt遵守设置
  - 爬取频率限制
  - 版权声明自动添加
  - 内容删除请求处理

## 10. 用户体验优化
- **响应式设计**
  - 移动端适配
  - 桌面端优化
- **个性化设置**
  - 界面主题选择
  - 通知偏好设置
  - 默认导出格式设置
- **多语言支持**
  - 中英文界面
  - 内容语言识别

## 技术栈建议
```
后端:
- 语言: Python (FastAPI/Django)
- 爬虫框架: Scrapy + Playwright/Selenium
- 任务队列: Celery + Redis/RabbitMQ
- 数据库: PostgreSQL (主数据) + Elasticsearch (搜索)
- 文件存储: MinIO/S3/本地存储

前端:
- 框架: Vue.js/React
- UI组件: Element Plus/Ant Design
- 状态管理: Pinia/Redux

部署:
- 容器化: Docker + Docker Compose
- 编排: Kubernetes (可选)
- 监控: Prometheus + Grafana
```

## 部署与扩展考虑
- **微服务架构**：将爬虫服务、Web服务、文件服务分离
- **水平扩展**：支持多爬虫节点并行工作
- **容错机制**：任务失败自动重试、断点续爬
- **数据备份**：定期备份数据库和文件

这个设计涵盖了从爬取到管理的完整流程，同时考虑了用户体验和系统可扩展性。可以根据项目规模和需求优先级分阶段实现这些功能。